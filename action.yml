name: Merge Comment Reminders
description: Pulls flagged comments from edited files and comments them on your PRs
branding:
  icon: check-square
  color: purple
inputs:
  token:
    description: "GITHUB_TOKEN or a repo scoped PAT."
    default: ${{ github.token }}
  repository:
    description: "The full name of the repository in which to create or update a comment."
    default: ${{ github.repository }}
  issue-number:
    description: "The number of the issue or pull request in which to create a comment."
  base-sha:
    description: "The hash of the base branch."
    required: true
    default: ${{ github.event.pull_request.base.sha }}
  head-sha:
    description: "The hash of the PR branch."
    default: ${{ github.event.pull_request.head.sha }}

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Find merge comments
      id: find-merge-comments
      shell: bash
      runs-on: ubuntu-latest
      run: |
        echo "Modified files:"
        files=$(git diff --name-only ${{ inputs.base-sha }} ${{ inputs.head-sha }})

        if [ -n "$files" ]; then
          echo "$files"
          echo ""

          echo "Modified lines:"
          lines=$(echo "$files" | xargs -r grep -r '[\/\/|#] MERGE:' || echo "")

          if [ -n "$lines" ]; then
            echo "$lines"
            echo ""

            echo "Formatting comments:"
            comments=$(echo "$lines" | sed 's/:.*[\/\/|#] MERGE/`/' | sed 's/^/- [ ] `/' )
            echo "$comments"
            echo ""

            echo 'comments<<EOF' >> $GITHUB_OUTPUT
            echo "$comments" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT

          else
            echo "None"
            echo "comments=None" >> "$GITHUB_OUTPUT"
          fi

        else
          echo "None"
          echo "comments=None" >> "$GITHUB_OUTPUT"
        fi

    - name: Find PR comment
      uses: peter-evans/find-comment@v3
      id: fc
      with:
        issue-number: ${{ inputs.issue-number }}
        comment-author: "github-actions[bot]"
        body-includes: Merge Reminders

    - name: Update PR comment
      uses: peter-evans/create-or-update-comment@v4.0.0
      with:
        comment-id: ${{ steps.fc.outputs.comment-id }}
        token: ${{ inputs.token }}
        repository: ${{ inputs.repository }}
        issue-number: ${{ inputs.issue-number }}
        edit-mode: replace
        body: |
          **Merge Reminders**
          ${{ steps.find-merge-comments.outputs.comments }}
        reactions: eyes
